{% import_yaml 'roundcube/defaults.yaml' as default_settings %}
{% set roundcube = salt['pillar.get']('roundcube', default=default_settings.get('roundcube'), merge=True) %}

{% set url = 'http://sourceforge.net/projects/roundcubemail/files/roundcubemail' %}
{% if '-' in roundcube.version %}
{% set url = url + '-beta' %}
{% endif %}
{% set url = url + '/' + roundcube.version + '/roundcubemail-' + roundcube.version + '.tar.gz/download' %}

{% do roundcube.update({
  'url': url,
  'source': '/tmp/roundcube-' + roundcube.version + '.tar.gz',
  'extract': roundcube.directory + '/extract',
  'install': roundcube.directory + '/install',
  'current': roundcube.directory + '/extract/roundcubemail-' + roundcube.version
}) %}

{% if roundcube.get('db') %}
{% set db = roundcube.db %}
{% do roundcube.config.update({
  'db_dsnw': db.type + '://' + db.username + ':' + db.password + '@' + db.host + '/' + db.database
}) %}
{% endif %}

{% if roundcube.get('plugins') %}
{% do roundcube.update({
  'composer': {
    'require': roundcube.plugins
  }
}) %}
{% endif %}